<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Parcel System</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .main-grid { grid-template-columns: 1fr; }
    }
    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .card h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5em;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }
    #video {
      width: 100%;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      background: #000;
    }
    canvas { display: none; }
    .camera-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .camera-controls button { flex: 1; }
    .recognize-section {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 15px;
    }
    #recognizeBtn { flex: 1; }
    #recognizedIdBox {
      flex: 0 0 150px;
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    #recognizedIdBox:hover {
      transform: scale(1.05);
    }
    #recognizedIdBox:active {
      transform: scale(0.95);
    }
    #recognizedIdBox.empty {
      background: #f5f5f5;
      color: #999;
      font-style: italic;
      font-size: 12px;
    }
    .id-label {
      font-size: 11px;
      font-weight: bold;
      color: #636e72;
      margin-bottom: 5px;
    }
    .id-value {
      font-size: 20px;
      font-weight: bold;
      color: #2d3436;
      letter-spacing: 3px;
      font-family: "Courier New", monospace;
    }
    .form-group { margin-bottom: 15px; }
    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border 0.3s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    button:hover {
      transform: scale(1.02);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    button:active { transform: scale(0.98); }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .btn-success {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    #result {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .loading { text-align: center; color: #667eea; }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .success-card {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      border-radius: 15px;
      padding: 30px;
      text-align: center;
    }
    .error-card {
      background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
      border-radius: 15px;
      padding: 30px;
      text-align: center;
    }
    .unique-id {
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
      padding: 20px;
      border-radius: 10px;
      font-size: 32px;
      font-weight: bold;
      letter-spacing: 8px;
      margin: 20px 0;
      font-family: "Courier New", monospace;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .welcome-text {
      font-size: 28px;
      color: #2d3436;
      margin: 15px 0;
    }
    .instruction-text {
      color: #636e72;
      margin-top: 15px;
      line-height: 1.8;
    }
    .status-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin: 5px;
    }
    .status-stored {
      background: #55efc4;
      color: #00b894;
    }
    .status-collected {
      background: #fd79a8;
      color: #e84393;
    }
    .camera-status {
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 14px;
      font-weight: bold;
    }
    .camera-status.active {
      background: #d4edda;
      color: #155724;
    }
    .camera-status.inactive {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1> Smart Parcel System</h1>
    <div class="main-grid">
      <div class="card">
        <h2> Face Recognition</h2>
        <div class="camera-status inactive" id="cameraStatus">Camera Off</div>
        
        <div class="form-group">
          <select id="cameraSelect" style="font-size: 12px;">
            <option value="">Loading cameras...</option>
          </select>
        </div>
        
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div class="camera-controls">
          <button id="startCameraBtn" class="btn-success">Start Camera</button>
          <button id="stopCameraBtn" class="btn-secondary" disabled>Stop Camera</button>
        </div>
        <hr style="margin: 20px 0; border: none; border-top: 2px dashed #e0e0e0;">
        <h2> Register New User</h2>
        <div class="form-group">
          <input id="name" placeholder="Your name">
        </div>
        <div class="form-group">
          <input id="phone" placeholder="Phone number (optional)">
        </div>
        <button id="registerBtn"> Register &amp; Get My ID</button>
        <hr style="margin: 20px 0; border: none; border-top: 2px dashed #e0e0e0;">
        <h2> Identify Me</h2>
        <div class="recognize-section">
          <button id="recognizeBtn" class="btn-secondary">Recognize Face</button>
          <div id="recognizedIdBox" class="empty">
            <div style="font-size: 12px;">Your ID will<br>appear here</div>
          </div>
        </div>
      </div>
      <div class="card">
        <h2> Add New Parcel</h2>
        <div class="form-group">
          <input id="tracking" placeholder="Tracking code">
        </div>
        <div class="form-group">
          <input id="owner_id" placeholder="Owner ID (or use face recognition)">
        </div>
        <div class="form-group">
          <input id="note" placeholder="Note (optional)">
        </div>
        <button id="addParcelBtn">Add Parcel</button>
        <hr style="margin: 20px 0; border: none; border-top: 2px dashed #e0e0e0;">
        <h2> Manage Parcels</h2>
        <button id="listMyParcelsBtn" class="btn-success">Show My Parcels</button>
        <div class="form-group" style="margin-top: 15px;">
          <select id="parcelsSelect">
            <option value="">-- Select a parcel --</option>
          </select>
        </div>
        <button id="collectParcelBtn" class="btn-secondary">Collect Selected Parcel</button>
        <hr style="margin: 20px 0; border: none; border-top: 2px dashed #e0e0e0;">
        <h2> Track by ID</h2>
        <div class="form-group">
          <input id="trackId" placeholder="Enter your 6-character ID" maxlength="6" style="text-transform: uppercase; text-align: center; letter-spacing: 4px; font-size: 18px;">
        </div>
        <button id="trackBtn">Track My Orders</button>
        <hr style="margin: 20px 0; border: none; border-top: 2px dashed #e0e0e0;">
        <h2> Search Parcel</h2>
        <div class="form-group">
          <input id="searchTracking" placeholder="Enter tracking code">
        </div>
        <div class="form-group">
          <input id="searchId" placeholder="Enter your ID" maxlength="6" style="text-transform: uppercase;">
        </div>
        <button id="searchBtn" class="btn-success">Search</button>
      </div>
    </div>
    <div id="result">
      <div style="color: #999; font-style: italic;">Results will appear here...</div>
    </div>
  </div>
  <script>const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const result = document.getElementById("result");
const cameraStatus = document.getElementById("cameraStatus");
const startCameraBtn = document.getElementById("startCameraBtn");
const stopCameraBtn = document.getElementById("stopCameraBtn");
const recognizedIdBox = document.getElementById("recognizedIdBox");
const cameraSelect = document.getElementById("cameraSelect");
let stream = null;
let cameraActive = false;
let availableCameras = [];

// Get list of available cameras
async function getCameras() {
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    availableCameras = devices.filter(device => device.kind === 'videoinput');
    
    cameraSelect.innerHTML = '';
    if (availableCameras.length === 0) {
      cameraSelect.innerHTML = '<option value="">No cameras found</option>';
    } else {
      availableCameras.forEach((camera, index) => {
        const option = document.createElement('option');
        option.value = camera.deviceId;
        option.text = camera.label || `Camera ${index + 1}`;
        cameraSelect.appendChild(option);
      });
    }
  } catch (err) {
    console.error('Error getting cameras:', err);
    cameraSelect.innerHTML = '<option value="">Error loading cameras</option>';
  }
}

async function startCamera(){
  try{
    if(stream){
      stream.getTracks().forEach(t=>t.stop())
    }
    
    const selectedDeviceId = cameraSelect.value;
    const constraints = {
      video: {
        deviceId: selectedDeviceId ? {exact: selectedDeviceId} : undefined,
        width: {ideal: 640},
        height: {ideal: 480}
      }
    };
    
    stream=await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject=stream;
    cameraActive=true;
    cameraStatus.textContent="✓ Camera Active";
    cameraStatus.className="camera-status active";
    startCameraBtn.disabled=true;
    stopCameraBtn.disabled=false;
    console.log("Camera started with device:", selectedDeviceId);
  }catch(err){
    showError("Camera Error: "+err.message+"<br><br>Please ensure:<br>• Camera permissions are granted<br>• Camera is not being used by another app");
    cameraStatus.textContent="✗ Camera Failed";
    cameraStatus.className="camera-status inactive"
  }
}

function stopCamera(){if(stream){stream.getTracks().forEach(t=>t.stop());stream=null}video.srcObject=null;cameraActive=false;cameraStatus.textContent="Camera Off";cameraStatus.className="camera-status inactive";startCameraBtn.disabled=false;stopCameraBtn.disabled=true;console.log("Camera stopped")}

startCameraBtn.addEventListener("click",startCamera);
stopCameraBtn.addEventListener("click",stopCamera);
cameraSelect.addEventListener("change", () => {
  if (cameraActive) {
    stopCamera();
    setTimeout(() => startCamera(), 300);
  }
});

window.addEventListener("load",()=>{
  getCameras().then(() => {
    setTimeout(startCamera,500);
  });
});
function captureImage(){if(!cameraActive){throw new Error("Camera is not active")}canvas.width=video.videoWidth;canvas.height=video.videoHeight;ctx.drawImage(video,0,0);return canvas.toDataURL("image/jpeg",0.8)}
async function postJson(url,body){return fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)})}
function showLoading(msg){result.innerHTML="<div class=\"loading\"><div class=\"spinner\"></div><p>"+(msg||"Processing...")+"</p></div>"}
function showSuccess(title,content){result.innerHTML="<div class=\"success-card\"><h2>"+title+"</h2>"+content+"</div>"}
function showError(msg){result.innerHTML="<div class=\"error-card\"><h2> Error</h2><p>"+msg+"</p></div>"}
function updateRecognizedIdBox(id){
  recognizedIdBox.className="";
  recognizedIdBox.innerHTML="<div class=\"id-label\">YOUR ID (Click to Copy)</div><div class=\"id-value\">"+id+"</div>";
  recognizedIdBox.onclick = () => {
    navigator.clipboard.writeText(id).then(() => {
      const original = recognizedIdBox.innerHTML;
      recognizedIdBox.innerHTML="<div class=\"id-label\" style=\"color:#00b894\">✓ COPIED!</div><div class=\"id-value\">"+id+"</div>";
      setTimeout(() => {
        recognizedIdBox.innerHTML = original;
      }, 1500);
    }).catch(err => {
      console.error('Copy failed:', err);
    });
  };
}
function clearRecognizedIdBox(){recognizedIdBox.className="empty";recognizedIdBox.innerHTML="<div style=\"font-size:12px\">Your ID will<br>appear here</div>"}
document.getElementById("registerBtn").addEventListener("click",async function(){if(!cameraActive){showError("Please start the camera first!");return}const name=document.getElementById("name").value.trim();const phone=document.getElementById("phone").value.trim();if(!name){showError("Please enter your name");return}showLoading("Capturing and registering your face...");try{const img=captureImage();const res=await postJson("/register",{name:name,phone:phone,image:img});const data=await res.json();if(data.error){showError(data.error)}else{const faceUuid=data.face_uuid||"N/A";updateRecognizedIdBox(faceUuid);showSuccess("Registration Successful! ","<h2 class=\"welcome-text\">Welcome, "+name+"! </h2><p style=\"color:#666;margin-top:10px\">Your Unique ID:</p><div class=\"unique-id\">"+faceUuid+"</div><div class=\"instruction-text\"> Your face has been registered<br> "+(data.synthetic_samples_created||0)+" training samples created<br> Use \"Identify Me\" button to recognize yourself<br> Your ID is now displayed next to the Identify button!</div>");document.getElementById("name").value="";document.getElementById("phone").value=""}}catch(err){showError("Registration failed: "+err.message)}});
document.getElementById("recognizeBtn").addEventListener("click",async function(){if(!cameraActive){showError("Please start the camera first!");return}showLoading("Recognizing your face...");try{const img=captureImage();const res=await postJson("/recognize",{image:img});if(res.status===404){clearRecognizedIdBox();showError("Face not recognized. Please register first.");return}if(res.status===500){const errorData=await res.json();const errorMsg=errorData.error||"Unknown error";if(errorMsg.includes("could not be detected")||errorMsg.includes("Face could not")){clearRecognizedIdBox();showError("Could not detect face clearly. Please ensure:<br><br> Your face is well-lit<br> You are looking at the camera<br> Your face is close enough to the camera<br> Remove any obstructions")}else{clearRecognizedIdBox();showError("Recognition failed: "+errorMsg)}return}const data=await res.json();if(data.match){const faceUuid=data.match.face_uuid||"N/A";updateRecognizedIdBox(faceUuid);showSuccess("Recognition Successful! ","<h2 class=\"welcome-text\">Hello, "+data.match.name+"! </h2><p style=\"color:#666;margin-top:10px\">Your Unique ID:</p><div class=\"unique-id\">"+faceUuid+"</div><div class=\"instruction-text\">Confidence Score: "+(data.match.score*100).toFixed(1)+"%<br>Your ID is now displayed next to the button!</div>")}else{clearRecognizedIdBox();showError("Could not recognize face. Please try again or register.")}}catch(err){clearRecognizedIdBox();showError("Recognition failed: "+err.message)}});
document.getElementById("addParcelBtn").addEventListener("click",async function(){
  const tracking=document.getElementById("tracking").value.trim();
  const owner_id=document.getElementById("owner_id").value.trim();
  const note=document.getElementById("note").value.trim();
  showLoading("Adding parcel...");
  const res=await postJson("/parcel/add",{tracking_code:tracking,owner_id:owner_id||null,note:note});
  const data=await res.json();
  if(data.error){
    showError(data.error)
  }else{
    showSuccess("Parcel Added! 📦",
      `<p style="font-size:18px;color:#2d3436">Parcel ID: <strong>${data.parcel_id}</strong></p>
       <p style="font-size:18px;color:#2d3436">Slot: <strong>${data.slot}</strong></p>
       <div style="background:#74b9ff;color:white;padding:15px;border-radius:10px;margin:15px 0">
         <strong>📍 Storage Location:</strong> ${data.storage_location}
       </div>
       <div style="background:#ffeaa7;padding:15px;border-radius:10px;margin:15px 0">
         <strong>⏰ Estimated Ready for Pickup:</strong> ${data.estimated_delivery_days} days
       </div>`);
    document.getElementById("tracking").value="";
    document.getElementById("owner_id").value="";
    document.getElementById("note").value=""
  }
});
document.getElementById("listMyParcelsBtn").addEventListener("click",async function(){if(!cameraActive){showError("Please start the camera first!");return}showLoading("Identifying and fetching your parcels...");try{const img=captureImage();const res=await postJson("/parcel/collect",{image:img});if(res.status===404){showError("Face not recognized or no parcels found");return}const data=await res.json();if(data.parcels){const select=document.getElementById("parcelsSelect");select.innerHTML="<option value=\"\">-- Select a parcel --</option>";data.parcels.forEach(function(p){const opt=document.createElement("option");opt.value=p.id;opt.textContent="#"+p.id+" - "+(p.tracking_code||"No tracking")+" - Slot "+p.slot+" - "+p.status;select.appendChild(opt)});let parcelsList=data.parcels.map(function(p){return "<div style=\"background:white;padding:15px;border-radius:10px;margin:10px 0;text-align:left\"><strong>Parcel #"+p.id+"</strong><br>Tracking: "+(p.tracking_code||"N/A")+"<br>Slot: "+p.slot+"<br>Status: <span class=\"status-badge status-"+p.status+"\">"+p.status.toUpperCase()+"</span></div>"}).join("");showSuccess("Your Parcels ("+data.parcels.length+")",parcelsList)}}catch(err){showError("Failed to fetch parcels: "+err.message)}});
document.getElementById("collectParcelBtn").addEventListener("click",async function(){if(!cameraActive){showError("Please start the camera first!");return}const parcelId=document.getElementById("parcelsSelect").value;if(!parcelId){showError("Please select a parcel first");return}showLoading("Verifying face and collecting parcel...");try{const img=captureImage();const res=await postJson("/parcel/collect",{image:img,parcel_id:parseInt(parcelId)});const data=await res.json();if(data.error){showError(data.error)}else{showSuccess("Parcel Collected! ","<p style=\"font-size:18px;color:#2d3436\">Parcel <strong>#"+parcelId+"</strong> has been collected successfully!</p><p style=\"margin-top:10px\">Status: <span class=\"status-badge status-collected\">COLLECTED</span></p>")}}catch(err){showError("Collection failed: "+err.message)}});
document.getElementById("trackBtn").addEventListener("click",async function(){
  const trackId=document.getElementById("trackId").value.trim().toUpperCase();
  if(!trackId){showError("Please enter your 6-character ID");return}
  showLoading("Tracking your orders...");
  try{
    const res=await fetch("/track/"+trackId);
    const data=await res.json();
    if(res.status===404){
      showError(data.error||"No parcels found for this ID")
    }else{
      let parcelsList=data.parcels.map(function(p){
        let timeInfo = "";
        if(p.status === 'stored'){
          if(p.days_remaining !== null && p.days_remaining !== undefined){
            timeInfo = `<div style="background:#ffeaa7;padding:10px;border-radius:5px;margin:10px 0">
              <strong>⏰ Pickup Time:</strong><br>
              ${p.days_remaining === 0 ? '<span style="color:#d63031">⚠️ Ready for pickup NOW!</span>' : 
                p.days_remaining === 1 ? '<span style="color:#fdcb6e">Tomorrow</span>' :
                `${p.days_remaining} days remaining`}
            </div>`;
          }
        }
        
        let locationInfo = p.storage_location ? 
          `<div style="background:#74b9ff;color:white;padding:10px;border-radius:5px;margin:10px 0">
            <strong>📍 Location:</strong> ${p.storage_location}
          </div>` : '';
        
        return `<div style="background:white;padding:20px;border-radius:10px;margin:10px 0;text-align:left;box-shadow:0 2px 8px rgba(0,0,0,0.1)">
          <strong style="font-size:18px">Parcel #${p.id}</strong><br>
          <strong>Tracking:</strong> ${p.tracking_code||'N/A'}<br>
          <strong>Slot:</strong> ${p.slot}<br>
          ${locationInfo}
          ${timeInfo}
          <strong>Status:</strong> <span class="status-badge status-${p.status}">${p.status.toUpperCase()}</span><br>
          ${p.note ? `<strong>Note:</strong> ${p.note}<br>` : ''}
          <small style="color:#999">In storage: ${p.days_in_storage||0} days</small>
        </div>`
      }).join("");
      
      showSuccess(`Parcels for ID: ${trackId} (${data.total_parcels} total)`, 
        `<div style="text-align:left"><strong>User:</strong> ${data.user.name}</div><br>` + parcelsList)
    }
  }catch(err){
    showError("Tracking failed: "+err.message)
  }
});
document.getElementById("searchBtn").addEventListener("click",async function(){const searchTracking=document.getElementById("searchTracking").value.trim();const searchId=document.getElementById("searchId").value.trim().toUpperCase();if(!searchTracking||!searchId){showError("Please enter both tracking code and your ID");return}showLoading("Searching for parcel...");try{const res=await postJson("/search",{tracking_code:searchTracking,face_uuid:searchId});const data=await res.json();if(res.status===404){showError(data.error||"Parcel not found")}else{const p=data.parcel;showSuccess("Parcel Found! ","<div style=\"background:white;padding:20px;border-radius:10px;text-align:left\"><strong style=\"font-size:20px\">Parcel #"+p.id+"</strong><br><br><strong>Tracking:</strong> "+(p.tracking_code||"N/A")+"<br><strong>Slot:</strong> "+p.slot+"<br><strong>Status:</strong> <span class=\"status-badge status-"+p.status+"\">"+p.status.toUpperCase()+"</span><br>"+(p.note?"<strong>Note:</strong> "+p.note+"<br>":"")+"</div>")}}catch(err){showError("Search failed: "+err.message)}});
document.getElementById("trackId").addEventListener("input",function(e){e.target.value=e.target.value.toUpperCase()});
document.getElementById("searchId").addEventListener("input",function(e){e.target.value=e.target.value.toUpperCase()});
  </script>
</body>
</html>